name: webpack

permissions: write-all

on:
    workflow_dispatch:    #ÊâãÂä®Ëß¶ÂèëÂºÄÂßãÁºñËØë
    
    watch:                #ÁÇπ‚òÜStarËß¶ÂèëÂºÄÂßãÁºñËØë
      types: started

jobs:
    publish:
        # To enable auto publishing to github, update your electron publisher
        # config in package.json > "build" and remove the conditional below
        # if: ${{ github.repository_owner == 'electron-react-boilerplate' }}

        runs-on: ${{ matrix.os }}

        strategy:
            matrix:
                os: [ubuntu-latest, windows-latest]
                # os: [ubuntu-latest, windows-latest, macos-latest]

        steps:
            - name: Checkout git repo
              uses: actions/checkout@v4

            - name: Install Node and NPM #ÂÆâË£ÖNodeÂíåNPM
              uses: actions/setup-node@v4
              with:
                  node-version: 18
                  cache: npm

            - name: Install and build #ÂÆâË£ÖÂíåÊûÑÂª∫
              run: |
                  npm install
                  if [ "$RUNNER_OS" == "macOS" ]; then
                    npm install dmg-license
                  fi
                  npm run postinstall
                  npm run build
              shell: bash

            - name: Publish releases #ÂèëÂ∏ÉÁâàÊú¨
              env:
                  # These values are used for auto updates signing
                  #   APPLE_ID: ${{ secrets.APPLE_ID }}
                  #   APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_ID_PASS }}
                  #   CSC_LINK: ${{ secrets.CSC_LINK }}
                  #   CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
                  # This is used for uploading release assets to github
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  npm exec electron-builder -- --publish always


            - name: Upload files to Artifacts #Â∞ÜÊñá‰ª∂‰∏äËΩΩÂà∞Â∑•‰ª∂
              uses: actions/upload-artifact@v3
              with:
                name: oblivion-desktop
                path: |
                  release/build/*.zip
                  release/build/*.exe
                  

            - name: Generate release tag #ÁîüÊàêÂèëÂ∏ÉÊ†áÁ≠æ
              id: tag
              run: |
                echo "release_tag=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_OUTPUT
                touch release.txt
                [ ${UPLOAD_GOFILE} = true && ${{ steps.gofile.outputs.url }} ] && echo "üîó [GoFile](${{ steps.gofile.outputs.url }})" >> release.txt
                echo "status=success" >> $GITHUB_OUTPUT
           
            - name: Upload firmware to release #‰∏ä‰º†Âõ∫‰ª∂‰ª•ÂèëÂ∏É
              uses: softprops/action-gh-release@master
              env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                tag_name: ${{ steps.tag.outputs.release_tag }}
                body_path: release.txt
                path: |
                  release/build/*.zip
                  release/build/*.exe                  
           
